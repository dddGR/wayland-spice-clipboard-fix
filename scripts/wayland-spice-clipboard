#!/bin/bash

export XDG_RUNTIME_DIR="/run/user/$(id -u)"

# Try to get wayland display socket, depend on the system
# sometime, when first boot up, wayland-x cannot found
# Reason: unknown
while true; do
    wayland_x=$(ls "$XDG_RUNTIME_DIR" | grep -o "wayland-[0-9][0-9]*" | head -n 1)

    if [[ -z "$wayland_x" ]]; then
        echo "'wayland-x' not found...try again"
        sleep 2
    else
        break
    fi
done

export WAYLAND_DISPLAY="$wayland_x"


# Detect X11 Display where spice-vdagent is connected to
if [ -n "$DISPLAY" ]; then
    X11_DISPLAY="$DISPLAY"
else
    # Find which display has an active X11 session
    for display in :0 :1 :2 :10; do
        if xset -display $display q >/dev/null 2>&1; then
            X11_DISPLAY="$display"
            break
        fi
    done

    # Fallback to socket detection if xset failed
    if [ -z "$X11_DISPLAY" ]; then
        if [ -S "/tmp/.X11-unix/X1" ]; then
            X11_DISPLAY=":1"
        elif [ -S "/tmp/.X11-unix/X0" ]; then
            X11_DISPLAY=":0"
        else
            X11_DISPLAY=":0"
        fi
    fi
fi

export DISPLAY="$X11_DISPLAY"

echo "Starting clipboard bridge"
echo "Using display: [$DISPLAY]"

switch_display() {
    # Try to find a working display
    for test_display in :0 :1 :2 :10; do
        if DISPLAY=$test_display xclip -version >/dev/null 2>&1; then
            export DISPLAY="$test_display"
            # echo "Switched to display: [$DISPLAY]"
            break
        fi
    done
}

# Verify that we can connect and clipboard works
if ! xclip -version >/dev/null 2>&1; then
    echo "Warning: Cannot connect to X11 display $DISPLAY"
    switch_display
fi

try_get() {
    output=$("$@" 2>&1)

    if [[ $? -ne 0 ]]; then
        # Ignore two error code when clipboard is empty
        if [[ ${output,,} != *"target string not available"* && ${output,,} != *"nothing is copied"* ]]; then
            # Try to switch to another display if current one cannot connect
            switch_display
        fi

        echo -n ""
    else
        echo -n "$output"
    fi
}

last_clipboard=""

while true; do
    cboard_host=$(try_get xclip -selection clipboard -o)
    cboard_guest=$(try_get wl-paste --no-newline)

    # evaluation host -> guest
    if [ "$cboard_host" != "$last_clipboard" ] && [ -n "$cboard_host" ]; then
        msg="Synced in: $(echo -n "$cboard_host" | wc -c) chars"
        echo -n "$cboard_host" | wl-copy && echo $msg
        last_clipboard="$cboard_host"

    # evaluation guest -> host
    elif [ "$cboard_guest" != "$last_clipboard" ] && [ -n "$cboard_guest" ]; then
        msg="Synced out: $(echo -n "$cboard_guest" | wc -c) chars"
        echo -n "$cboard_guest" | xclip -selection clipboard -i && echo $msg
        last_clipboard="$cboard_guest"
    fi

    sleep 2
done
